# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.
#
# http://go.microsoft.com/fwlink/?LinkID=615560

# Builds the library and test suite using the MinGW compiler.

schedules:
- cron: "0 0 * * *"
  displayName: 'Nightly build'
  branches:
    include:
    - main

trigger:
  branches:
    include:
    - main
  paths:
    exclude:
    - README.md
    - HISTORY.md
    - SECURITY.md
    - LICENSE
pr:
  branches:
    include:
    - main
  paths:
    exclude:
    - README.md
    - HISTORY.md
    - SECURITY.md
    - LICENSE
  drafts: false

resources:
  repositories:
  - repository: self
    type: git
    ref: refs/heads/main

name: $(Year:yyyy).$(Month).$(DayOfMonth)$(Rev:.r)

pool:
  vmImage: windows-2022

variables:
  GITHUB_PAT: $(GITHUBPUBLICTOKEN)

jobs:
- job: MINGW32_BUILD
  displayName: 'Minimalist GNU for Windows (MinGW32)'
  steps:
  - checkout: self
    clean: true
    fetchTags: false
  - task: CmdLine@2
    displayName: Fetch Tests
    inputs:
      script: git clone --quiet https://%GITHUB_PAT%@github.com/walbourn/directxmathtest.git Tests
      workingDirectory: $(Build.SourcesDirectory)
  - task: CmdLine@2
    displayName: GCC version
    inputs:
      script: g++ --version
  - task: CMake@1
    displayName: CMake (MinGW32) Dbg
    inputs:
      cwd: Tests
      cmakeArgs: -B out -DCMAKE_BUILD_TYPE="Debug" -DDXMATH_ARCHITECTURE=x86 -DCMAKE_CXX_COMPILER="g++.exe" -G "MinGW Makefiles"
  - task: CMake@1
    displayName: CMake (MinGW32) Build Dbg
    inputs:
      cwd: Tests
      cmakeArgs: --build out
  - task: CMake@1
    displayName: CMake (MinGW32) Rel
    inputs:
      cwd: Tests
      cmakeArgs: -B out2 -DCMAKE_BUILD_TYPE="RelWithDebInfo" -DDXMATH_ARCHITECTURE=x86 -DCMAKE_CXX_COMPILER="g++.exe" -G "MinGW Makefiles"
  - task: CMake@1
    displayName: CMake (MinGW32) Build Rel
    inputs:
      cwd: Tests
      cmakeArgs: --build out2
  - task: CMake@1
    displayName: CMake (MinGW32) Dbg NI
    inputs:
      cwd: Tests
      cmakeArgs: -B out3 -DCMAKE_BUILD_TYPE="Debug" -DBUILD_NO_INTRINSICS=ON -DDXMATH_ARCHITECTURE=x86 -DCMAKE_CXX_COMPILER="g++.exe" -G "MinGW Makefiles"
  - task: CMake@1
    displayName: CMake (MinGW32) Build Dbg NI
    inputs:
      cwd: Tests
      cmakeArgs: --build out3

- job: MINGW64_BUILD
  displayName: 'Minimalist GNU for Windows (MinGW-W64) BUILD_TESTING=ON'
  steps:
  - checkout: self
    clean: true
    fetchTags: false
  - task: CmdLine@2
    displayName: Fetch Tests
    inputs:
      script: git clone --quiet https://%GITHUB_PAT%@github.com/walbourn/directxmathtest.git Tests
      workingDirectory: $(Build.SourcesDirectory)
  - task: CmdLine@2
    displayName: GCC version
    inputs:
      script: g++ --version
  - task: CMake@1
    displayName: CMake (MinGW-W64) Dbg
    inputs:
      cwd: Tests
      cmakeArgs: -B out -DCMAKE_BUILD_TYPE="Debug" -DDXMATH_ARCHITECTURE=x64 -DCMAKE_CXX_COMPILER="g++.exe" -G "MinGW Makefiles"
  - task: CMake@1
    displayName: CMake (MinGW-W64) Build Dbg
    inputs:
      cwd: Tests
      cmakeArgs: --build out
  - task: CMake@1
    displayName: CMake (MinGW-W64) Rel
    inputs:
      cwd: Tests
      cmakeArgs: -B out2 -DCMAKE_BUILD_TYPE="RelWithDebInfo" -DDXMATH_ARCHITECTURE=x64 -DCMAKE_CXX_COMPILER="g++.exe" -G "MinGW Makefiles"
  - task: CMake@1
    displayName: CMake (MinGW-W64) Build Rel
    inputs:
      cwd: Tests
      cmakeArgs: --build out2
  - task: CMake@1
    displayName: CMake (MinGW-W64) Dbg NI
    inputs:
      cwd: Tests
      cmakeArgs: -B out3 -DCMAKE_BUILD_TYPE="Debug" -DBUILD_NO_INTRINSICS=ON -DDXMATH_ARCHITECTURE=x64 -DCMAKE_CXX_COMPILER="g++.exe" -G "MinGW Makefiles"
  - task: CMake@1
    displayName: CMake (MinGW-W64) Build Dbg NI
    inputs:
      cwd: Tests
      cmakeArgs: --build out3
